---
title: 《Antlr权威指南》笔记
date: 2020-12-02 17:10:16
tags:
	- Antlr
	- 笔记
	- 语法
categories:
	- Antlr


---

## 第二章 纵观全局

### 2.1 元语言开始

* 语言由一系列有意义的语句组成，语句（sentence）由词组组成，词组（phrase）由更小的子词组（subphrase）和词汇符号（vocabulary symbol）组成。
* 一般来说，一个程序能够分析计算或者“执行”语句，我们称之为**解释器（interpreter）**。例子：计算器、读取配置文件的程序和Python解释器。
* 一个程序能够将一门语言的语句转换为另外一门语言的语句，我们称之为**翻译器（translator）**。例子：Java到C#的转换器和普通的编译器。
* 识别语言的程序称为**语法分析器（parser）或者句法分析器（syntax analyzer）**。句法（syntax）是指约束语言中的各个组成部分之间关系的规则。
* 将字符聚集为**单词或者符号（词法符号，token）**的过程称为**词法分析（lexical analysis）**或者**词法符号化（tokenizing）**。
* 我们把可以将输入文本转换为词法符号的程序称为**词法分析器（lexer）**。词法分析器可以将相关的词法符号归类，例，INT（整数）、ID（标识符）、FLOAT（浮点数）等。词法符号包含至少两部分信息：词法符号的类型（从而能够通过类型来识别词法结构）和该词法符号对应的文本。
* 语法分析器会构建一种名为**语法分析树（parse tree）**或者**句法树（syntax tree）**的数据结构，该数据结构记录了语法分析器识别出输入语句结构的过程，以及该结构的各组成部分。
* ![图2-1 某数据在语言类程序中的流动过程](https://ww1.sinaimg.cn/large/6af0fe46ly1gm73e72ndgj20fj03s3yb.jpg)
* 语法分析树的内部节点是词组名，这些名字用于识别它们的子节点，并将子节点归类。语法分析树的叶子节点永远是输入的词法符号。

### 2.2 实现一个语法分析器

* Antlr会依据语法规则，产生一个递归下降的**语法分析器（recursive-descent parser）**。递归下降的语法分析器实际上是若干递归方法的集合，每个方法对应一条规则。下降的过程就是从语法分析树的根节点开始，朝着叶节点（语法符号）进行解析的过程。这种解析过程是**“自上而下的解析”**递归下降的语法分析器仅仅是自上而下的语法分析器的一种实现。
* **前瞻词法符号（lookahead token）**是指任何一个在被匹配和消费之前就由语法分析器嗅探出的词法符号。有些时候，词法分析器需要很多个前瞻词符号来判断语义规则的哪个方案是正确的，甚至可能要从当前的词法符号的位置开始，一直分析到文件末尾才能做出判断。
* 语法分析的决策过程可视化。想想一个迷宫，它只有一个入口和一个出口，迷宫的地板上写着单词。每个从入口到出口的路径上的单词序列代表一个语句。这个迷宫的结构就好比是一种语言所定义的全部语法规则。为了测试一个语句是不是合法，我们将这个语句中的单词和迷宫在地板上的单词比较，然后沿着这个语句的单词所描述的路径在迷宫中前进。如果能够通过这个语句中的单词序列指定的路径到达出口，那这个语句就是合法的。
* 当每条岔路的起始单词有重复的时候，语法分析器就需要更多地进行前瞻，即通过扫描更多的单词来区分不同的备选分支。在每次语法分析决策中，Antlr能够根据情况自动调整前瞻的数量。

### 2.3 歧义性语句

* 歧义性语句是指存在不止一种语义的语句。
* Antlr解决歧义问题的方法是：选择所有匹配的备选分支中的第一条。
* 语法分析器会匹配可能的最长字符串来生成一个词法符号。
* 语法分析器本身仅仅验证输入语句的合法性并建立一棵语法分析树。

### 2.4 使用语法分析树来构建语言类应用程序

* **词法分析器**处理字符序列并生成的**词法符号**提供给**语法分析器**，语法分析器随即根据这些信息来检查语法的正确性并建造出一棵**语法分析树**。这个过程对应的Antlr类是CharStream、Lexer、Token、Parser，以及ParseTree。连接**词法分析器**和**语法分析器**的“管道”是TokenStream。如图2-2。
* <img src="https://ww1.sinaimg.cn/large/6af0fe46ly1gmbwf418p5j20mm0mv0t3.jpg" alt="图2-2 部分对象在内存中的交互方式" style="zoom:50%;" />
* ParseTree的子类RuleNode和TerminalNode，二者分别是子树的根节点和叶子节点。为了更好的支持对特定节点的元素的访问，Antlr会为每条规则生成一个RuleNode的子类。如图2-3所示，赋值语句的例子中，子树根节点的类型实际上是StatContext、AssignContext以及ExprContext。
* <img src="https://ww1.sinaimg.cn/large/6af0fe46ly1gmbwfvhq9wj20mm0bd0st.jpg" alt="图2-3 语法分析树" style="zoom:50%;" />
* 根节点包含了使用规则识别词组过程中的全部信息，它们被称为**上下文（context）对象**。每个上下文对象都知道自己识别出的词组中，开始和结束位置处的词法符号，同事提供访问该词组全部元素的途径。

### 2.5 语法分析树监听器和访问器

* Antlr运行库提供了两种遍历树的机制。

#### 2.5.1 语法分析树监听器

* Antlr为每个语法文件生成一个ParseTreeListener的子类，在该类中，语法中的每条规则都有对应的enter方法和exit方法。

* ![图2-4 ParseTreeWalker对语法分析树进行深度优先遍历的过程](https://ww1.sinaimg.cn/large/6af0fe46ly1gmngajxkt4j20mn0g60t2.jpg)
* ![图2-5 ParseTreeWalker调用序列](/Users/sqlist/Library/Application Support/typora-user-images/image-20210115143702626.png)

#### 2.5.2 语法分析树访问器

* 在命令行中加入```-visitor```选项可以指示Antlr为一个语法生成访问器接口，语法中的每条规则对应接口中的一个visit方法。
* ![图2-6 使用常见的访问者模式对语法分析树进行操作的过程](https://ww1.sinaimg.cn/large/6af0fe46ly1gmohkf9m0vj20mq08emxe.jpg)

### 2.6 术语总结

* **语言**：一门语言是一个有效语句的集合。语句由词组组成，词组由子词组组成，子词组又由更小的子词组组成，以此类推。
* **语法**：语法定义了语言的语义规则。语法中的每条规则定义了一种词组结构。
* **语义树或语法分析树**：代表了语句的结构，其中的每个子树的根节点都使用一个抽象的名字给其包含的元素命名。即子树的根节点对应了语法规则的名字。树的叶子节点是语句中的符号或者词法符号。
* **词法符号**：词法符号就是一门语言的基本词汇符号，它们可以代表像是“标识符”这样的一类符号，也可以代表一个单一的运算符或者代表一个关键字。
* **词法分析器或者词法符号生成器**：将输入的字符序列分解成一系列词法符号。一个词法分析器负责分析词法。
* **语法分析器**：语法分析器通过检查语句的结构是否符号语法规则的定义来验证该语句在特定语言中是否合法。语法分析的过程好比是走迷宫，通过比较语句中和地板上的单词来从入口走到出口。Antlr能够生成被称为All（\*）的自顶向下的语法分析器，All（\*）是指它可以利用剩余的所有输入文本来进行决策。自顶向下的语法分析器以结构为导向，首先匹配最粗粒度的规则，这样的规则通常命名为program。
* **递归下降的语法分析器**：这是自顶向下的预发分析器的一种实现，每条规则都对应语法分析器中的一个函数。
* **前向预测**：语法分析器使用前向预测来进行决策，具体方法是：将输入的符号与每个备选分支的起始符号进行比较。



## 第三章 入门

